<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>flask.helpers &#8212; proxypool  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="proxypool  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for flask.helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    flask.helpers</span>
<span class="sd">    ~~~~~~~~~~~~~</span>

<span class="sd">    Implements various helpers.</span>

<span class="sd">    :copyright: (c) 2015 by Armin Ronacher.</span>
<span class="sd">    :license: BSD, see LICENSE for more details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">zlib</span> <span class="k">import</span> <span class="n">adler32</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">RLock</span>
<span class="kn">from</span> <span class="nn">werkzeug.routing</span> <span class="k">import</span> <span class="n">BuildError</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">update_wrapper</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.urls</span> <span class="k">import</span> <span class="n">url_quote</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="k">import</span> <span class="n">quote</span> <span class="k">as</span> <span class="n">url_quote</span>

<span class="kn">from</span> <span class="nn">werkzeug.datastructures</span> <span class="k">import</span> <span class="n">Headers</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="k">import</span> <span class="n">BadRequest</span><span class="p">,</span> <span class="n">NotFound</span>

<span class="c1"># this was moved in 0.7</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.wsgi</span> <span class="k">import</span> <span class="n">wrap_file</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="k">import</span> <span class="n">wrap_file</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="k">import</span> <span class="n">FileSystemLoader</span>

<span class="kn">from</span> <span class="nn">.signals</span> <span class="k">import</span> <span class="n">message_flashed</span>
<span class="kn">from</span> <span class="nn">.globals</span> <span class="k">import</span> <span class="n">session</span><span class="p">,</span> <span class="n">_request_ctx_stack</span><span class="p">,</span> <span class="n">_app_ctx_stack</span><span class="p">,</span> \
     <span class="n">current_app</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">._compat</span> <span class="k">import</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">text_type</span>


<span class="c1"># sentinel</span>
<span class="n">_missing</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="c1"># what separators does this operating system provide that are not a slash?</span>
<span class="c1"># this is used by the send_from_directory function to ensure that nobody is</span>
<span class="c1"># able to access files from outside the filesystem.</span>
<span class="n">_os_alt_seps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sep</span> <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">altsep</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="get_debug_flag"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.get_debug_flag">[docs]</a><span class="k">def</span> <span class="nf">get_debug_flag</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_DEBUG&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_endpoint_from_view_func</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper that returns the default endpoint for a given</span>
<span class="sd">    function.  This always is the function name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">view_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;expected view func if endpoint &#39;</span> \
                                  <span class="s1">&#39;is not provided.&#39;</span>
    <span class="k">return</span> <span class="n">view_func</span><span class="o">.</span><span class="n">__name__</span>


<div class="viewcode-block" id="stream_with_context"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.stream_with_context">[docs]</a><span class="k">def</span> <span class="nf">stream_with_context</span><span class="p">(</span><span class="n">generator_or_function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Request contexts disappear when the response is started on the server.</span>
<span class="sd">    This is done for efficiency reasons and to make it less likely to encounter</span>
<span class="sd">    memory leaks with badly written WSGI middlewares.  The downside is that if</span>
<span class="sd">    you are using streamed responses, the generator cannot access request bound</span>
<span class="sd">    information any more.</span>

<span class="sd">    This function however can help you keep the context around for longer::</span>

<span class="sd">        from flask import stream_with_context, request, Response</span>

<span class="sd">        @app.route(&#39;/stream&#39;)</span>
<span class="sd">        def streamed_response():</span>
<span class="sd">            @stream_with_context</span>
<span class="sd">            def generate():</span>
<span class="sd">                yield &#39;Hello &#39;</span>
<span class="sd">                yield request.args[&#39;name&#39;]</span>
<span class="sd">                yield &#39;!&#39;</span>
<span class="sd">            return Response(generate())</span>

<span class="sd">    Alternatively it can also be used around a specific generator::</span>

<span class="sd">        from flask import stream_with_context, request, Response</span>

<span class="sd">        @app.route(&#39;/stream&#39;)</span>
<span class="sd">        def streamed_response():</span>
<span class="sd">            def generate():</span>
<span class="sd">                yield &#39;Hello &#39;</span>
<span class="sd">                yield request.args[&#39;name&#39;]</span>
<span class="sd">                yield &#39;!&#39;</span>
<span class="sd">            return Response(stream_with_context(generate()))</span>

<span class="sd">    .. versionadded:: 0.9</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">generator_or_function</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">generator_or_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stream_with_context</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">generator_or_function</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Attempted to stream with context but &#39;</span>
                <span class="s1">&#39;there was no context in the first place to keep around.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="c1"># Dummy sentinel.  Has to be inside the context block or we&#39;re</span>
            <span class="c1"># not actually keeping the context around.</span>
            <span class="k">yield</span> <span class="kc">None</span>

            <span class="c1"># The try/finally is here so that if someone passes a WSGI level</span>
            <span class="c1"># iterator in we&#39;re still running the cleanup logic.  Generators</span>
            <span class="c1"># don&#39;t need that because they are closed on their destruction</span>
            <span class="c1"># automatically.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">item</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
                    <span class="n">gen</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># The trick is to start the generator.  Then the code execution runs until</span>
    <span class="c1"># the first dummy None is yielded at which point the context was already</span>
    <span class="c1"># pushed.  This item is discarded.  Then when the iteration continues the</span>
    <span class="c1"># real generator is executed.</span>
    <span class="n">wrapped_g</span> <span class="o">=</span> <span class="n">generator</span><span class="p">()</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">wrapped_g</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped_g</span></div>


<div class="viewcode-block" id="make_response"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.make_response">[docs]</a><span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sometimes it is necessary to set additional headers in a view.  Because</span>
<span class="sd">    views do not have to return response objects but can return a value that</span>
<span class="sd">    is converted into a response object by Flask itself, it becomes tricky to</span>
<span class="sd">    add headers to it.  This function can be called instead of using a return</span>
<span class="sd">    and you will get a response object which you can use to attach headers.</span>

<span class="sd">    If view looked like this and you want to add a new header::</span>

<span class="sd">        def index():</span>
<span class="sd">            return render_template(&#39;index.html&#39;, foo=42)</span>

<span class="sd">    You can now do something like this::</span>

<span class="sd">        def index():</span>
<span class="sd">            response = make_response(render_template(&#39;index.html&#39;, foo=42))</span>
<span class="sd">            response.headers[&#39;X-Parachutes&#39;] = &#39;parachutes are cool&#39;</span>
<span class="sd">            return response</span>

<span class="sd">    This function accepts the very same arguments you can return from a</span>
<span class="sd">    view function.  This for example creates a response with a 404 error</span>
<span class="sd">    code::</span>

<span class="sd">        response = make_response(render_template(&#39;not_found.html&#39;), 404)</span>

<span class="sd">    The other use case of this function is to force the return value of a</span>
<span class="sd">    view function into a response which is helpful with view</span>
<span class="sd">    decorators::</span>

<span class="sd">        response = make_response(view_function())</span>
<span class="sd">        response.headers[&#39;X-Parachutes&#39;] = &#39;parachutes are cool&#39;</span>

<span class="sd">    Internally this function does the following things:</span>

<span class="sd">    -   if no arguments are passed, it creates a new response argument</span>
<span class="sd">    -   if one argument is passed, :meth:`flask.Flask.make_response`</span>
<span class="sd">        is invoked with it.</span>
<span class="sd">    -   if more than one argument is passed, the arguments are passed</span>
<span class="sd">        to the :meth:`flask.Flask.make_response` function as tuple.</span>

<span class="sd">    .. versionadded:: 0.6</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">response_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="url_for"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.url_for">[docs]</a><span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a URL to the given endpoint with the method provided.</span>

<span class="sd">    Variable arguments that are unknown to the target endpoint are appended</span>
<span class="sd">    to the generated URL as query arguments.  If the value of a query argument</span>
<span class="sd">    is ``None``, the whole pair is skipped.  In case blueprints are active</span>
<span class="sd">    you can shortcut references to the same blueprint by prefixing the</span>
<span class="sd">    local endpoint with a dot (``.``).</span>

<span class="sd">    This will reference the index function local to the current blueprint::</span>

<span class="sd">        url_for(&#39;.index&#39;)</span>

<span class="sd">    For more information, head over to the :ref:`Quickstart &lt;url-building&gt;`.</span>

<span class="sd">    To integrate applications, :class:`Flask` has a hook to intercept URL build</span>
<span class="sd">    errors through :attr:`Flask.url_build_error_handlers`.  The `url_for`</span>
<span class="sd">    function results in a :exc:`~werkzeug.routing.BuildError` when the current</span>
<span class="sd">    app does not have a URL for the given endpoint and values.  When it does, the</span>
<span class="sd">    :data:`~flask.current_app` calls its :attr:`~Flask.url_build_error_handlers` if</span>
<span class="sd">    it is not ``None``, which can return a string to use as the result of</span>
<span class="sd">    `url_for` (instead of `url_for`&#39;s default to raise the</span>
<span class="sd">    :exc:`~werkzeug.routing.BuildError` exception) or re-raise the exception.</span>
<span class="sd">    An example::</span>

<span class="sd">        def external_url_handler(error, endpoint, values):</span>
<span class="sd">            &quot;Looks up an external URL when `url_for` cannot build a URL.&quot;</span>
<span class="sd">            # This is an example of hooking the build_error_handler.</span>
<span class="sd">            # Here, lookup_url is some utility function you&#39;ve built</span>
<span class="sd">            # which looks up the endpoint in some external URL registry.</span>
<span class="sd">            url = lookup_url(endpoint, **values)</span>
<span class="sd">            if url is None:</span>
<span class="sd">                # External lookup did not have a URL.</span>
<span class="sd">                # Re-raise the BuildError, in context of original traceback.</span>
<span class="sd">                exc_type, exc_value, tb = sys.exc_info()</span>
<span class="sd">                if exc_value is error:</span>
<span class="sd">                    raise exc_type, exc_value, tb</span>
<span class="sd">                else:</span>
<span class="sd">                    raise error</span>
<span class="sd">            # url_for will use this result, instead of raising BuildError.</span>
<span class="sd">            return url</span>

<span class="sd">        app.url_build_error_handlers.append(external_url_handler)</span>

<span class="sd">    Here, `error` is the instance of :exc:`~werkzeug.routing.BuildError`, and</span>
<span class="sd">    `endpoint` and `values` are the arguments passed into `url_for`.  Note</span>
<span class="sd">    that this is for building URLs outside the current application, and not for</span>
<span class="sd">    handling 404 NotFound errors.</span>

<span class="sd">    .. versionadded:: 0.10</span>
<span class="sd">       The `_scheme` parameter was added.</span>

<span class="sd">    .. versionadded:: 0.9</span>
<span class="sd">       The `_anchor` and `_method` parameters were added.</span>

<span class="sd">    .. versionadded:: 0.9</span>
<span class="sd">       Calls :meth:`Flask.handle_build_error` on</span>
<span class="sd">       :exc:`~werkzeug.routing.BuildError`.</span>

<span class="sd">    :param endpoint: the endpoint of the URL (name of the function)</span>
<span class="sd">    :param values: the variable arguments of the URL rule</span>
<span class="sd">    :param _external: if set to ``True``, an absolute URL is generated. Server</span>
<span class="sd">      address can be changed via ``SERVER_NAME`` configuration variable which</span>
<span class="sd">      defaults to `localhost`.</span>
<span class="sd">    :param _scheme: a string specifying the desired URL scheme. The `_external`</span>
<span class="sd">      parameter must be set to ``True`` or a :exc:`ValueError` is raised. The default</span>
<span class="sd">      behavior uses the same scheme as the current request, or</span>
<span class="sd">      ``PREFERRED_URL_SCHEME`` from the :ref:`app configuration &lt;config&gt;` if no</span>
<span class="sd">      request context is available. As of Werkzeug 0.10, this also can be set</span>
<span class="sd">      to an empty string to build protocol-relative URLs.</span>
<span class="sd">    :param _anchor: if provided this is added as anchor to the URL.</span>
<span class="sd">    :param _method: if provided this explicitly specifies an HTTP method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">appctx</span> <span class="o">=</span> <span class="n">_app_ctx_stack</span><span class="o">.</span><span class="n">top</span>
    <span class="n">reqctx</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span>
    <span class="k">if</span> <span class="n">appctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Attempted to generate a URL without the &#39;</span>
                           <span class="s1">&#39;application context being pushed. This has to be &#39;</span>
                           <span class="s1">&#39;executed when application context is available.&#39;</span><span class="p">)</span>

    <span class="c1"># If request specific information is available we have some extra</span>
    <span class="c1"># features that support &quot;relative&quot; URLs.</span>
    <span class="k">if</span> <span class="n">reqctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">url_adapter</span> <span class="o">=</span> <span class="n">reqctx</span><span class="o">.</span><span class="n">url_adapter</span>
        <span class="n">blueprint_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">blueprint</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reqctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_is_old_module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">endpoint</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">blueprint_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">blueprint_name</span> <span class="o">+</span> <span class="n">endpoint</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: get rid of this deprecated functionality in 1.0</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">blueprint_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">blueprint_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">endpoint</span>
            <span class="k">elif</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">external</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_external&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Otherwise go with the url adapter from the appctx and make</span>
    <span class="c1"># the URLs external by default.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url_adapter</span> <span class="o">=</span> <span class="n">appctx</span><span class="o">.</span><span class="n">url_adapter</span>
        <span class="k">if</span> <span class="n">url_adapter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Application was not able to create a URL &#39;</span>
                               <span class="s1">&#39;adapter for request independent URL generation. &#39;</span>
                               <span class="s1">&#39;You might be able to fix this by setting &#39;</span>
                               <span class="s1">&#39;the SERVER_NAME config variable.&#39;</span><span class="p">)</span>
        <span class="n">external</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_external&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">anchor</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_anchor&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_method&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">scheme</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_scheme&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">appctx</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">inject_url_defaults</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="c1"># This is not the best way to deal with this but currently the</span>
    <span class="c1"># underlying Werkzeug router does not support overriding the scheme on</span>
    <span class="c1"># a per build call basis.</span>
    <span class="n">old_scheme</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When specifying _scheme, _external must be True&#39;</span><span class="p">)</span>
        <span class="n">old_scheme</span> <span class="o">=</span> <span class="n">url_adapter</span><span class="o">.</span><span class="n">url_scheme</span>
        <span class="n">url_adapter</span><span class="o">.</span><span class="n">url_scheme</span> <span class="o">=</span> <span class="n">scheme</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">url_adapter</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                   <span class="n">force_external</span><span class="o">=</span><span class="n">external</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url_adapter</span><span class="o">.</span><span class="n">url_scheme</span> <span class="o">=</span> <span class="n">old_scheme</span>
    <span class="k">except</span> <span class="n">BuildError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="c1"># We need to inject the values again so that the app callback can</span>
        <span class="c1"># deal with that sort of stuff.</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;_external&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">external</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;_anchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">return</span> <span class="n">appctx</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">handle_url_build_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">anchor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">url_quote</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rv</span></div>


<div class="viewcode-block" id="get_template_attribute"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.get_template_attribute">[docs]</a><span class="k">def</span> <span class="nf">get_template_attribute</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a macro (or variable) a template exports.  This can be used to</span>
<span class="sd">    invoke a macro from within Python code.  If you for example have a</span>
<span class="sd">    template named :file:`_cider.html` with the following contents:</span>

<span class="sd">    .. sourcecode:: html+jinja</span>

<span class="sd">       {% macro hello(name) %}Hello {{ name }}!{% endmacro %}</span>

<span class="sd">    You can access this from Python code like this::</span>

<span class="sd">        hello = get_template_attribute(&#39;_cider.html&#39;, &#39;hello&#39;)</span>
<span class="sd">        return hello(&#39;World&#39;)</span>

<span class="sd">    .. versionadded:: 0.2</span>

<span class="sd">    :param template_name: the name of the template</span>
<span class="sd">    :param attribute: the name of the variable of macro to access</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                   <span class="n">attribute</span><span class="p">)</span></div>


<div class="viewcode-block" id="flash"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.flash">[docs]</a><span class="k">def</span> <span class="nf">flash</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;message&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Flashes a message to the next request.  In order to remove the</span>
<span class="sd">    flashed message from the session and to display it to the user,</span>
<span class="sd">    the template has to call :func:`get_flashed_messages`.</span>

<span class="sd">    .. versionchanged:: 0.3</span>
<span class="sd">       `category` parameter added.</span>

<span class="sd">    :param message: the message to be flashed.</span>
<span class="sd">    :param category: the category for the message.  The following values</span>
<span class="sd">                     are recommended: ``&#39;message&#39;`` for any kind of message,</span>
<span class="sd">                     ``&#39;error&#39;`` for errors, ``&#39;info&#39;`` for information</span>
<span class="sd">                     messages and ``&#39;warning&#39;`` for warnings.  However any</span>
<span class="sd">                     kind of string can be used as category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Original implementation:</span>
    <span class="c1">#</span>
    <span class="c1">#     session.setdefault(&#39;_flashes&#39;, []).append((category, message))</span>
    <span class="c1">#</span>
    <span class="c1"># This assumed that changes made to mutable structures in the session are</span>
    <span class="c1"># are always in sync with the session object, which is not true for session</span>
    <span class="c1"># implementations that use external storage for keeping their keys/values.</span>
    <span class="n">flashes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_flashes&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">flashes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">category</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;_flashes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flashes</span>
    <span class="n">message_flashed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(),</span>
                         <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_flashed_messages"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.get_flashed_messages">[docs]</a><span class="k">def</span> <span class="nf">get_flashed_messages</span><span class="p">(</span><span class="n">with_categories</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">category_filter</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Pulls all flashed messages from the session and returns them.</span>
<span class="sd">    Further calls in the same request to the function will return</span>
<span class="sd">    the same messages.  By default just the messages are returned,</span>
<span class="sd">    but when `with_categories` is set to ``True``, the return value will</span>
<span class="sd">    be a list of tuples in the form ``(category, message)`` instead.</span>

<span class="sd">    Filter the flashed messages to one or more categories by providing those</span>
<span class="sd">    categories in `category_filter`.  This allows rendering categories in</span>
<span class="sd">    separate html blocks.  The `with_categories` and `category_filter`</span>
<span class="sd">    arguments are distinct:</span>

<span class="sd">    * `with_categories` controls whether categories are returned with message</span>
<span class="sd">      text (``True`` gives a tuple, where ``False`` gives just the message text).</span>
<span class="sd">    * `category_filter` filters the messages down to only those matching the</span>
<span class="sd">      provided categories.</span>

<span class="sd">    See :ref:`message-flashing-pattern` for examples.</span>

<span class="sd">    .. versionchanged:: 0.3</span>
<span class="sd">       `with_categories` parameter added.</span>

<span class="sd">    .. versionchanged:: 0.9</span>
<span class="sd">        `category_filter` parameter added.</span>

<span class="sd">    :param with_categories: set to ``True`` to also receive categories.</span>
<span class="sd">    :param category_filter: whitelist of categories to limit return values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flashes</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">flashes</span>
    <span class="k">if</span> <span class="n">flashes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">flashes</span> <span class="o">=</span> <span class="n">flashes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_flashes&#39;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="s1">&#39;_flashes&#39;</span> <span class="ow">in</span> <span class="n">session</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">category_filter</span><span class="p">:</span>
        <span class="n">flashes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">category_filter</span><span class="p">,</span> <span class="n">flashes</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">with_categories</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flashes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flashes</span></div>


<div class="viewcode-block" id="send_file"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.send_file">[docs]</a><span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="n">filename_or_fp</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">attachment_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_etags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">cache_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conditional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends the contents of a file to the client.  This will use the</span>
<span class="sd">    most efficient method available and configured.  By default it will</span>
<span class="sd">    try to use the WSGI server&#39;s file_wrapper support.  Alternatively</span>
<span class="sd">    you can set the application&#39;s :attr:`~Flask.use_x_sendfile` attribute</span>
<span class="sd">    to ``True`` to directly emit an ``X-Sendfile`` header.  This however</span>
<span class="sd">    requires support of the underlying webserver for ``X-Sendfile``.</span>

<span class="sd">    By default it will try to guess the mimetype for you, but you can</span>
<span class="sd">    also explicitly provide one.  For extra security you probably want</span>
<span class="sd">    to send certain files as attachment (HTML for instance).  The mimetype</span>
<span class="sd">    guessing requires a `filename` or an `attachment_filename` to be</span>
<span class="sd">    provided.</span>

<span class="sd">    Please never pass filenames to this function from user sources;</span>
<span class="sd">    you should use :func:`send_from_directory` instead.</span>

<span class="sd">    .. versionadded:: 0.2</span>

<span class="sd">    .. versionadded:: 0.5</span>
<span class="sd">       The `add_etags`, `cache_timeout` and `conditional` parameters were</span>
<span class="sd">       added.  The default behavior is now to attach etags.</span>

<span class="sd">    .. versionchanged:: 0.7</span>
<span class="sd">       mimetype guessing and etag support for file objects was</span>
<span class="sd">       deprecated because it was unreliable.  Pass a filename if you are</span>
<span class="sd">       able to, otherwise attach an etag yourself.  This functionality</span>
<span class="sd">       will be removed in Flask 1.0</span>

<span class="sd">    .. versionchanged:: 0.9</span>
<span class="sd">       cache_timeout pulls its default from application config, when None.</span>

<span class="sd">    :param filename_or_fp: the filename of the file to send in `latin-1`.</span>
<span class="sd">                           This is relative to the :attr:`~Flask.root_path`</span>
<span class="sd">                           if a relative path is specified.</span>
<span class="sd">                           Alternatively a file object might be provided in</span>
<span class="sd">                           which case ``X-Sendfile`` might not work and fall</span>
<span class="sd">                           back to the traditional method.  Make sure that the</span>
<span class="sd">                           file pointer is positioned at the start of data to</span>
<span class="sd">                           send before calling :func:`send_file`.</span>
<span class="sd">    :param mimetype: the mimetype of the file if provided, otherwise</span>
<span class="sd">                     auto detection happens.</span>
<span class="sd">    :param as_attachment: set to ``True`` if you want to send this file with</span>
<span class="sd">                          a ``Content-Disposition: attachment`` header.</span>
<span class="sd">    :param attachment_filename: the filename for the attachment if it</span>
<span class="sd">                                differs from the file&#39;s filename.</span>
<span class="sd">    :param add_etags: set to ``False`` to disable attaching of etags.</span>
<span class="sd">    :param conditional: set to ``True`` to enable conditional responses.</span>

<span class="sd">    :param cache_timeout: the timeout in seconds for the headers. When ``None``</span>
<span class="sd">                          (default), this value is set by</span>
<span class="sd">                          :meth:`~Flask.get_send_file_max_age` of</span>
<span class="sd">                          :data:`~flask.current_app`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename_or_fp</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_or_fp</span>
        <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">filename_or_fp</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># XXX: this behavior is now deprecated because it was unreliable.</span>
        <span class="c1"># removed in Flask 1.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attachment_filename</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mimetype</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;The filename support for file objects &#39;</span>
                <span class="s1">&#39;passed to send_file is now deprecated.  Pass an &#39;</span>
                <span class="s1">&#39;attach_filename if you want mimetypes to be guessed.&#39;</span><span class="p">),</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_etags</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;In future flask releases etags will no &#39;</span>
                <span class="s1">&#39;longer be generated for file objects passed to the send_file &#39;</span>
                <span class="s1">&#39;function because this behavior was unreliable.  Pass &#39;</span>
                <span class="s1">&#39;filenames instead if possible, otherwise attach an etag &#39;</span>
                <span class="s1">&#39;yourself based on another value&#39;</span><span class="p">),</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="n">attachment_filename</span><span class="p">):</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="n">attachment_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">as_attachment</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attachment_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;filename unavailable, required for &#39;</span>
                                <span class="s1">&#39;sending as attachment&#39;</span><span class="p">)</span>
            <span class="n">attachment_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span> <span class="s1">&#39;attachment&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">attachment_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">use_x_sendfile</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Sendfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">wrap_file</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="n">mimetype</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                    <span class="n">direct_passthrough</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># if we know the file modification date, we can store it as</span>
    <span class="c1"># the time of the last modification.</span>
    <span class="k">if</span> <span class="n">mtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span>

    <span class="n">rv</span><span class="o">.</span><span class="n">cache_control</span><span class="o">.</span><span class="n">public</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">cache_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_timeout</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">get_send_file_max_age</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">cache_control</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">cache_timeout</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">cache_timeout</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">add_etags</span> <span class="ow">and</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rv</span><span class="o">.</span><span class="n">set_etag</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                <span class="n">adler32</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">text_type</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">filename</span>
                <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
            <span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Access </span><span class="si">%s</span><span class="s1"> failed, maybe it does not exist, so ignore etags in &#39;</span>
                 <span class="s1">&#39;headers&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">conditional</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">make_conditional</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="c1"># make sure we don&#39;t send x-sendfile for servers that</span>
            <span class="c1"># ignore the 304 status code for x-sendfile.</span>
            <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
                <span class="n">rv</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;x-sendfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rv</span></div>


<div class="viewcode-block" id="safe_join"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.safe_join">[docs]</a><span class="k">def</span> <span class="nf">safe_join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Safely join `directory` and `filename`.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        @app.route(&#39;/wiki/&lt;path:filename&gt;&#39;)</span>
<span class="sd">        def wiki_page(filename):</span>
<span class="sd">            filename = safe_join(app.config[&#39;WIKI_FOLDER&#39;], filename)</span>
<span class="sd">            with open(filename, &#39;rb&#39;) as fd:</span>
<span class="sd">                content = fd.read()  # Read and process the file content...</span>

<span class="sd">    :param directory: the base directory.</span>
<span class="sd">    :param filename: the untrusted filename relative to that directory.</span>
<span class="sd">    :raises: :class:`~werkzeug.exceptions.NotFound` if the resulting path</span>
<span class="sd">             would fall out of `directory`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">_os_alt_seps</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> \
       <span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;..&#39;</span> <span class="ow">or</span> \
       <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="send_from_directory"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.send_from_directory">[docs]</a><span class="k">def</span> <span class="nf">send_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Send a file from a given directory with :func:`send_file`.  This</span>
<span class="sd">    is a secure way to quickly expose static files from an upload folder</span>
<span class="sd">    or something similar.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        @app.route(&#39;/uploads/&lt;path:filename&gt;&#39;)</span>
<span class="sd">        def download_file(filename):</span>
<span class="sd">            return send_from_directory(app.config[&#39;UPLOAD_FOLDER&#39;],</span>
<span class="sd">                                       filename, as_attachment=True)</span>

<span class="sd">    .. admonition:: Sending files and Performance</span>

<span class="sd">       It is strongly recommended to activate either ``X-Sendfile`` support in</span>
<span class="sd">       your webserver or (if no authentication happens) to tell the webserver</span>
<span class="sd">       to serve files for the given path on its own without calling into the</span>
<span class="sd">       web application for improved performance.</span>

<span class="sd">    .. versionadded:: 0.5</span>

<span class="sd">    :param directory: the directory where all the files are stored.</span>
<span class="sd">    :param filename: the filename relative to that directory to</span>
<span class="sd">                     download.</span>
<span class="sd">    :param options: optional keyword arguments that are directly</span>
<span class="sd">                    forwarded to :func:`send_file`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">safe_join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">()</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;conditional&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_root_path"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.get_root_path">[docs]</a><span class="k">def</span> <span class="nf">get_root_path</span><span class="p">(</span><span class="n">import_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the path to a package or cwd if that cannot be found.  This</span>
<span class="sd">    returns the path of a package or the folder that contains a module.</span>

<span class="sd">    Not to be confused with the package path returned by :func:`find_package`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Module already imported and has a file attribute.  Use that first.</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">__file__</span><span class="p">))</span>

    <span class="c1"># Next attempt: check the loader.</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_loader</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>

    <span class="c1"># Loader does not exist or we&#39;re referring to an unloaded main module</span>
    <span class="c1"># or a main module without path (interactive sessions), go with the</span>
    <span class="c1"># current working directory.</span>
    <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">import_name</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># For .egg, zipimporter does not have get_filename until Python 2.7.</span>
    <span class="c1"># Some other loaders might exhibit the same behavior.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;get_filename&#39;</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fall back to imports.</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">import_name</span><span class="p">]</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If we don&#39;t have a filepath it might be because we are a</span>
        <span class="c1"># namespace package.  In this case we pick the root path from the</span>
        <span class="c1"># first module that is contained in our package.</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No root path can be found for the provided &#39;</span>
                               <span class="s1">&#39;module &quot;</span><span class="si">%s</span><span class="s1">&quot;.  This can happen because the &#39;</span>
                               <span class="s1">&#39;module came from an import hook that does &#39;</span>
                               <span class="s1">&#39;not provide file name information or because &#39;</span>
                               <span class="s1">&#39;it</span><span class="se">\&#39;</span><span class="s1">s a namespace package.  In this case &#39;</span>
                               <span class="s1">&#39;the root path needs to be explicitly &#39;</span>
                               <span class="s1">&#39;provided.&#39;</span> <span class="o">%</span> <span class="n">import_name</span><span class="p">)</span>

    <span class="c1"># filepath is import_name.py for a module, or __init__.py for a package.</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_matching_loader_thinks_module_is_package</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given the loader that loaded a module and the module this function</span>
<span class="sd">    attempts to figure out if the given module is actually a package.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the loader can tell us if something is a package, we can</span>
    <span class="c1"># directly ask the loader.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;is_package&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="n">is_package</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
    <span class="c1"># importlib&#39;s namespace loaders do not have this functionality but</span>
    <span class="c1"># all the modules it loads are packages, so we can take advantage of</span>
    <span class="c1"># this information.</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s1">&#39;_frozen_importlib&#39;</span> <span class="ow">and</span>
          <span class="n">loader</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;NamespaceLoader&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># Otherwise we need to fail with an error that explains what went</span>
    <span class="c1"># wrong.</span>
    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.is_package() method is missing but is required by Flask of &#39;</span>
         <span class="s1">&#39;PEP 302 import hooks.  If you do not use import hooks and &#39;</span>
         <span class="s1">&#39;you encounter this error please file a bug against Flask.&#39;</span><span class="p">)</span> <span class="o">%</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="find_package"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.find_package">[docs]</a><span class="k">def</span> <span class="nf">find_package</span><span class="p">(</span><span class="n">import_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds a package and returns the prefix (or None if the package is</span>
<span class="sd">    not installed) as well as the folder that contains the package or</span>
<span class="sd">    module as a tuple.  The package path returned is the module that would</span>
<span class="sd">    have to be added to the pythonpath in order to make it possible to</span>
<span class="sd">    import the module.  The prefix is the path below which a UNIX like</span>
<span class="sd">    folder structure exists (lib, share etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_mod_name</span> <span class="o">=</span> <span class="n">import_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_loader</span><span class="p">(</span><span class="n">root_mod_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">import_name</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="c1"># import name is not found, or interactive/main module</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For .egg, zipimporter does not have get_filename until Python 2.7.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;get_filename&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">root_mod_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;archive&#39;</span><span class="p">):</span>
            <span class="c1"># zipimporter&#39;s loader.archive points to the .egg or .zip</span>
            <span class="c1"># archive filename is dropped in call to dirname below.</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">archive</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># At least one loader is missing both get_filename and archive:</span>
            <span class="c1"># Google App Engine&#39;s HardenedModulesHook</span>
            <span class="c1">#</span>
            <span class="c1"># Fall back to imports.</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">import_name</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c1"># In case the root module is a package we need to chop of the</span>
        <span class="c1"># rightmost part.  This needs to go through a helper function</span>
        <span class="c1"># because of python 3.3 namespace packages.</span>
        <span class="k">if</span> <span class="n">_matching_loader_thinks_module_is_package</span><span class="p">(</span>
                <span class="n">loader</span><span class="p">,</span> <span class="n">root_mod_name</span><span class="p">):</span>
            <span class="n">package_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span>

    <span class="n">site_parent</span><span class="p">,</span> <span class="n">site_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span>
    <span class="n">py_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">package_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">py_prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">py_prefix</span><span class="p">,</span> <span class="n">package_path</span>
    <span class="k">elif</span> <span class="n">site_folder</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;site-packages&#39;</span><span class="p">:</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">site_parent</span><span class="p">)</span>
        <span class="c1"># Windows like installations</span>
        <span class="k">if</span> <span class="n">folder</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lib&#39;</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="c1"># UNIX like installations</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lib&#39;</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">site_parent</span>
        <span class="k">return</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">package_path</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">package_path</span></div>


<div class="viewcode-block" id="locked_cached_property"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.locked_cached_property">[docs]</a><span class="k">class</span> <span class="nc">locked_cached_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A decorator that converts a function into a lazy property.  The</span>
<span class="sd">    function wrapped is called the first time to retrieve the result</span>
<span class="sd">    and then that calculated result is used the next time you access</span>
<span class="sd">    the value.  Works like the one in Werkzeug but has a lock for</span>
<span class="sd">    thread safety.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">doc</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">_missing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">_missing</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span></div>


<span class="k">class</span> <span class="nc">_PackageBoundObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_name</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#: The name of the package or module.  Do not change this once</span>
        <span class="c1">#: it was set by the constructor.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_name</span> <span class="o">=</span> <span class="n">import_name</span>

        <span class="c1">#: location of the templates.  ``None`` if templates should not be</span>
        <span class="c1">#: exposed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_folder</span> <span class="o">=</span> <span class="n">template_folder</span>

        <span class="k">if</span> <span class="n">root_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_path</span> <span class="o">=</span> <span class="n">get_root_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_name</span><span class="p">)</span>

        <span class="c1">#: Where is the app root located?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_static_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_url_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_static_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_static_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_folder</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">static_folder</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_static_folder</span><span class="p">,</span> <span class="n">_set_static_folder</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    The absolute path to the configured static folder.</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">_get_static_folder</span><span class="p">,</span> <span class="n">_set_static_folder</span>

    <span class="k">def</span> <span class="nf">_get_static_url_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_url_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_url_path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_folder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_static_url_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_url_path</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">static_url_path</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_static_url_path</span><span class="p">,</span> <span class="n">_set_static_url_path</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">_get_static_url_path</span><span class="p">,</span> <span class="n">_set_static_url_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_static_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is ``True`` if the package bound object&#39;s container has a</span>
<span class="sd">        folder for static files.</span>

<span class="sd">        .. versionadded:: 0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@locked_cached_property</span>
    <span class="k">def</span> <span class="nf">jinja_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Jinja loader for this package bound object.</span>

<span class="sd">        .. versionadded:: 0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">template_folder</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_send_file_max_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides default cache_timeout for the :func:`send_file` functions.</span>

<span class="sd">        By default, this function returns ``SEND_FILE_MAX_AGE_DEFAULT`` from</span>
<span class="sd">        the configuration of :data:`~flask.current_app`.</span>

<span class="sd">        Static file functions such as :func:`send_from_directory` use this</span>
<span class="sd">        function, and :func:`send_file` calls this function on</span>
<span class="sd">        :data:`~flask.current_app` when the given cache_timeout is ``None``. If a</span>
<span class="sd">        cache_timeout is given in :func:`send_file`, that timeout is used;</span>
<span class="sd">        otherwise, this method is called.</span>

<span class="sd">        This allows subclasses to change the behavior when sending files based</span>
<span class="sd">        on the filename.  For example, to set the cache timeout for .js files</span>
<span class="sd">        to 60 seconds::</span>

<span class="sd">            class MyFlask(flask.Flask):</span>
<span class="sd">                def get_send_file_max_age(self, name):</span>
<span class="sd">                    if name.lower().endswith(&#39;.js&#39;):</span>
<span class="sd">                        return 60</span>
<span class="sd">                    return flask.Flask.get_send_file_max_age(self, name)</span>

<span class="sd">        .. versionadded:: 0.9</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">total_seconds</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">send_file_max_age_default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_static_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function used internally to send static files from the static</span>
<span class="sd">        folder to the browser.</span>

<span class="sd">        .. versionadded:: 0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_static_folder</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No static folder for this object&#39;</span><span class="p">)</span>
        <span class="c1"># Ensure get_send_file_max_age is called in all cases.</span>
        <span class="c1"># Here, we ensure get_send_file_max_age is called for Blueprints.</span>
        <span class="n">cache_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_send_file_max_age</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                                   <span class="n">cache_timeout</span><span class="o">=</span><span class="n">cache_timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Opens a resource from the application&#39;s resource folder.  To see</span>
<span class="sd">        how this works, consider the following folder structure::</span>

<span class="sd">            /myapplication.py</span>
<span class="sd">            /schema.sql</span>
<span class="sd">            /static</span>
<span class="sd">                /style.css</span>
<span class="sd">            /templates</span>
<span class="sd">                /layout.html</span>
<span class="sd">                /index.html</span>

<span class="sd">        If you want to open the :file:`schema.sql` file you would do the</span>
<span class="sd">        following::</span>

<span class="sd">            with app.open_resource(&#39;schema.sql&#39;) as f:</span>
<span class="sd">                contents = f.read()</span>
<span class="sd">                do_something_with(contents)</span>

<span class="sd">        :param resource: the name of the resource.  To access resources within</span>
<span class="sd">                         subfolders use forward slashes as separator.</span>
<span class="sd">        :param mode: resource file opening mode, default is &#39;rb&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Resources can only be opened for reading&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">resource</span><span class="p">),</span> <span class="n">mode</span><span class="p">)</span>


<div class="viewcode-block" id="total_seconds"><a class="viewcode-back" href="../../flask/flask.html#flask.helpers.total_seconds">[docs]</a><span class="k">def</span> <span class="nf">total_seconds</span><span class="p">(</span><span class="n">td</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the total seconds from a timedelta object.</span>

<span class="sd">    :param timedelta td: the timedelta to be converted in seconds</span>

<span class="sd">    :returns: number of seconds</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">seconds</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>